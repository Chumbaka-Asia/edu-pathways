<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Our Curriculum</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&amp;display=swap" rel="stylesheet"/>
<style>
    :root { --gap: 20px; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f7f9;
      color: #111827;
      margin: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    h1.title { font-weight: 800; font-size: 2rem; margin: 0 0 10px 0; }

    .pathway-container { display: flex; flex-direction: column; gap: 32px; width: 100%; max-width: 1200px; }

    .level-section { display: flex; flex-direction: column; gap: 16px; }

    .level-label {
      background: var(--level-color);
      color: #fff; text-align: center; padding: 18px; border-radius: 14px;
      font-weight: 700; font-size: 1.2rem; cursor: pointer; position: relative;
    }
    .level-label::after { content: '▸'; position: absolute; right: 16px; top: 50%; transform: translateY(-50%); opacity: .9; font-size: 1.1rem; }
    .level-section.open .level-label::after { content: '▾'; }

    .course-row { /* collapsed by default */ display: none; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: var(--gap); align-items: start; }
    .level-section.open .course-row { display: grid; }

    @media (max-width: 1024px) { .course-row { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 640px)  { .course-row { grid-template-columns: 1fr; } }

    .track-col { display: grid; gap: var(--gap); }

    .course-block {
      background: var(--level-color); color:#fff; border-radius:12px; padding:20px; width:100%; min-height:100px; box-sizing:border-box;
      display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; font-weight:600; position:relative;
      box-shadow:0 3px 6px rgba(0,0,0,.1); transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease, filter .18s ease;
    }
    .course-block:hover { transform: translateY(-4px); box-shadow: 0 10px 22px rgba(0,0,0,.1); }
    .course-block.highlight { box-shadow: 0 0 0 3px rgba(59,130,246,.55), 0 10px 22px rgba(0,0,0,.25); }

    .track-bubble { position:absolute; top:10px; left:10px; background:rgba(0,0,0,.25); color:#fff; font-weight:700; font-size:.8rem; border-radius:999px; padding:4px 10px; text-transform:uppercase; }

    /* Dim everything except the active card when dialog is open */
    .dim-others .course-block { opacity: 0.35; filter: grayscale(0.6); }
    .dim-others .course-block.active { opacity: 1; filter: none; }

    /* Suggested-next chips shown in the dialog */
    .next-chips { margin-top: 10px; margin-bottom: 24px; display: flex; flex-wrap: wrap; gap: 8px; }
    .next-chip  { border:1px solid rgba(0,0,0,.15); background:#eef2ff; color:#1f2937; border-radius:999px; padding:4px 10px; font-size:12px; font-weight:700; cursor:pointer; }
    .next-chip:hover { background:#e0e7ff; }

    .chips-title { margin: 6px 0 4px; font-weight: 700; color: #374151; }

    dialog { border:none; border-radius:14px; box-shadow:0 10px 35px rgba(0,0,0,.12); padding:20px; max-width:560px; width:90%; }
    dialog::backdrop { background: rgba(0,0,0,.22); }

    .visually-hidden { position: absolute !important; left: -9999px !important; }

    /* Hide UI during tests to avoid initial flash */
    body.testing .pathway-container,
    body.testing dialog { visibility: hidden !important; }
  

/* === Filters sidebar and filtering states === */
#page { display: flex; gap: 20px; width: 100%; max-width: 1160px; }
#filterPane{
  position: sticky; top: 16px;
  width: 260px; min-width: 260px;
  padding: 16px; border: 1px solid rgba(0,0,0,.08); border-radius: 12px;
  background: #fff;
  max-height: calc(100dvh - 32px); overflow: auto;
}
#pathway{ flex: 1; }

.filter-section{ margin-bottom: 16px; }
.filter-label{ display:block; font-size: .9rem; margin-bottom: 6px; color:#444; }
#filterSearch{
  width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd;
  background: #fff;
}
.filter-title{ font-weight: 600; margin: 10px 0 6px; }
.ck{ display:block; font-size: .95rem; margin: 6px 0; cursor: pointer; }
.ck input{ margin-right: 8px; }
.filter-actions{ margin-top: 12px; }
#filterClear{
  width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; cursor:pointer;
}
#filterClear:hover{ background:#f2f2f2; }

/* Gray out unmatched courses when filters apply */
.course-block.is-filtered-out{
  opacity: .28 !important;
  filter: grayscale(0.5) !important;
  pointer-events: none;
}
.course-block.is-filtered-in{
  outline: 2px solid rgba(80,130,255,.25);
  outline-offset: 2px;
}


/* === Mobile-first improvements === */
.filter-toggle{
  display:none;
  border:1px solid #ddd; background:#fff; border-radius:10px;
  padding:10px 14px; font-weight:600; cursor:pointer;
  position:sticky; top:8px; z-index:20;
}

/* Base tweaks so cards fit better on phones */
.course-block { min-height:auto; padding:16px; }
.level-label  { padding:14px; border-radius:12px; font-size:1.1rem; }

/* Responsive: phones & small tablets */
@media (max-width: 768px){
  #page{ flex-direction:column; gap:12px; }

  /* Show the toggle and collapse the sidebar by default */
  .filter-toggle{ display:block; }

  #filterPane{
    position:static; width:100%; min-width:unset; max-height:none; 
    display:none; /* hidden until opened */
    padding:12px; border-radius:12px;
  }
  #filterPane.open{ display:block; }

  /* Single-column course grid on small screens */
  .course-row{ grid-template-columns:1fr !important; gap:12px; }

  /* Slightly smaller chips/labels inside cards */
  .track-bubble{ transform:scale(.9); transform-origin:left top; }
}

/* Optional: medium screens (tablets) = two columns */
@media (min-width: 769px) and (max-width: 1024px){
  .course-row{ grid-template-columns:repeat(2, minmax(0,1fr)) !important; }
}


/* === Spacing fix: keep desktop spacing; apply tighter padding only on mobile === */
@media (min-width: 769px){
  .course-block { padding:20px; min-height:100px; } /* restore desktop */
  .level-label  { padding:18px 24px; font-size:1.35rem; }
  .course-row   { grid-template-columns: repeat(3, minmax(0, 1fr)); gap: var(--gap, 20px); align-items: stretch; }
}
@media (max-width: 768px){
  .course-block { padding:16px; min-height:auto; }
  .level-label  { padding:14px; font-size:1.1rem; }
  .course-row   { grid-template-columns: 1fr !important; gap:12px; }
}
/* Ensure cards fill their grid cell height and remove stray margins */
.course-block{ margin:0; box-sizing:border-box; display:flex; flex-direction:column; justify-content:center; }
/* Optional: limit hover lift to desktop so it doesn't cause visual unevenness on mobile */
@media (max-width: 768px){
  .course-block:hover { transform:none; box-shadow:0 3px 6px rgba(0,0,0,.1); }
}
</style>
</head>
<body>
<h1 class="title">Our Curriculum</h1>
<div id="page"><button aria-controls="filterPane" aria-expanded="false" class="filter-toggle" id="filterToggle" type="button">Filters</button><aside aria-label="Course filters" id="filterPane">
<div class="filter-section">
<label class="filter-label" for="filterSearch">Search</label>
<input autocomplete="off" id="filterSearch" placeholder="Search courses…" type="search"/>
</div>
<div class="filter-section">
<div class="filter-title">Filter by tracks</div>
<label class="ck"><input name="track" type="checkbox" value="Designer"/> Designer</label>
<label class="ck"><input name="track" type="checkbox" value="Coder"/> Coder</label>
<label class="ck"><input name="track" type="checkbox" value="Maker"/> Maker</label>
</div>
<div class="filter-section">
<div class="filter-title">Filter by topics</div>
<label class="ck"><input name="topic" type="checkbox" value="Blocks"/> Blocks</label>
<label class="ck"><input name="topic" type="checkbox" value="Electronics"/> Electronics</label>
<label class="ck"><input name="topic" type="checkbox" value="Storytelling"/> Storytelling</label>
<label class="ck"><input name="topic" type="checkbox" value="3D Design"/> 3D Design</label>
<label class="ck"><input name="topic" type="checkbox" value="Game Dev"/> Game Dev</label>
<label class="ck"><input name="topic" type="checkbox" value="Arduino"/> Arduino</label>
<label class="ck"><input name="topic" type="checkbox" value="AI"/> AI</label>
<label class="ck"><input name="topic" type="checkbox" value="App Dev"/> App Dev</label>
<label class="ck"><input name="topic" type="checkbox" value="IoT Systems"/> IoT Systems</label>
</div>
<div class="filter-actions">
<button id="filterClear" type="button">Clear</button>
</div>
</aside><div class="pathway-container" id="pathway"></div></div>
<dialog aria-modal="true" id="detailsDialog">
<h3 id="dTitle"></h3>
<p id="dMeta"></p>
<p id="dDesc"></p>
<div class="chips-title" id="dNextTitle" style="display:none">Suggested Next Course(s):</div>
<div class="next-chips" id="dNext"></div>
<button id="closeBtn">Close</button>
</dialog>
<pre aria-hidden="true" class="visually-hidden" id="testLog"></pre>
<script>
    // ===== Config & Data =====
    const LEVEL_COLORS = { 1: '#d868a8', 2: '#80b45a', 3: '#4b89da', 4: '#e6914a' };
    const LEVEL_NAMES  = {
      1: 'Level 1 – Lower Primary',
      2: 'Level 2 – Upper Primary',
      3: 'Level 3 – Lower Secondary',
      4: 'Level 4 – Upper Secondary'
    };

    const SUGGESTED_NEXT = {
      'Blocks 1: Play and Code': ['Blocks 2: Mobile Coding','Electronics 1: Circuits and STEM','Storytelling 1: Digital Animation'],
      'Blocks 2: Mobile Coding': ['3D Design 1: Build with TinkerCad','Electronics 1: Circuits and STEM','Storytelling 1: Digital Animation'],
      'Electronics 1: Circuits and STEM': ['Electronics 2: Machines and Robots','Blocks 1: Play and Code','Storytelling 1: Digital Animation'],
      'Electronics 2: Machines and Robots': ['Blocks 1: Play and Code','Storytelling 1: Digital Animation'],
      'Storytelling 1: Digital Animation': ['Storytelling 2: Creative Computing'],
      '3D Design 1: Build with TinkerCad': ['3D Design 2: Modelling with SketchUp','Storytelling 1: Digital Animation','Electronics 1: Circuits and STEM'],
      'Storytelling 2: Creative Computing': ['Game Dev 1: Mini Games Creation','Electronics 1: Circuits and STEM','3D Design 1: Build with TinkerCad'],
      'Game Dev 1: Mini Games Creation': ['AI 1: Computational Thinking','Electronics 1: Circuits and STEM'],
      'Arduino 1: Physical Computing': ['Arduino 2: Human Computer Interaction','AI 1: Computational Thinking'],
      'Arduino 2: Human Computer Interaction': ['Arduino 3: Machine Learning with Sensors','AI 1: Computational Thinking'],
      'AI 1: Computational Thinking': ['AI 2: Problem Solving and Algorithm','Electronics 1: Circuits and STEM','Storytelling 1: Digital Animation'],
      'AI 2: Problem Solving and Algorithm': ['App Dev 1: UI Design & Mobile Games','Arduino 1: Physical Computing'],
      '3D Design 2: Modelling with SketchUp': ['3D Design 3: Animate with Blender'],
      'Game Dev 2: Designing for XR': ['Game Dev 3: Level Up with Godot','AI 1: Computational Thinking'],
      'Arduino 3: Machine Learning with Sensors': ['Arduino 4: Programming with C','AI 1: Computational Thinking'],
      'Arduino 4: Programming with C': ['IoT Systems 1: Smart Devices with ESP32'],
      'App Dev 1: UI Design & Mobile Games': ['App Dev 2: APIs and Database Integration'],
      'App Dev 2: APIs and Database Integration': ['AI 3: Data and Regression'],
      'AI 3: Data and Regression': ['AI 4: Predictive and Probabilistic Models'],
      'AI 4: Predictive and Probabilistic Models': ['IoT Systems 1: Smart Devices with ESP32'],
      'IoT Systems 1: Smart Devices with ESP32': ['IoT Systems 2: Edge Computing with AI'],
      'IoT Systems 2: Edge Computing with AI': [],
      '3D Design 3: Animate with Blender': [],
      'Game Dev 3: Level Up with Godot': []
    };

    const COURSES = [
      // Level 1 (6)
      {title: 'Storytelling 1: Digital Animation', track: 'Designer', focus: 'Frame-by-frame digital animation', prereq: '', level: 1},
      {title: '3D Design 1: Build with TinkerCad', track: 'Designer', focus: '3D modelling and simulation', prereq: 'Blocks 2: Mobile Coding', level: 1},
      {title: 'Blocks 1: Play and Code', track: 'Coder', focus: 'Learn coding through games and unplugged activities', prereq: '', level: 1},
      {title: 'Blocks 2: Mobile Coding', track: 'Coder', focus: 'Interactive coding using visual blocks with OctoStudio', prereq: 'Blocks 1: Play and Code', level: 1},
      {title: 'Electronics 1: Circuits and STEM', track: 'Maker', focus: 'Basic electronics and STEM concept', prereq: '', level: 1},
      {title: 'Electronics 2: Machines and Robots', track: 'Maker', focus: 'Build mechanical systems using motors and gears', prereq: 'Electronics 1: Circuits and STEM', level: 1},

      // Level 2 (6)
      {title: 'Storytelling 2: Creative Computing', track: 'Designer', focus: 'Animation, storytelling, and music projects', prereq: 'Blocks 2: Mobile Coding, Storytelling 1: Digital Animation', level: 2},
      {title: 'Game Dev 1: Mini Games Creation', track: 'Designer', focus: 'Build interactive 2D games', prereq: 'Storytelling 2: Creative Computing', level: 2},
      {title: 'AI 1: Computational Thinking', track: 'Coder', focus: 'Explore coding concepts using Python', prereq: 'Game Dev 1: Mini Games Creation', level: 2},
      {title: 'AI 2: Problem Solving and Algorithm', track: 'Coder', focus: 'Python programming for problem solving', prereq: 'AI 1: Computational Thinking', level: 2},
      {title: 'Arduino 1: Physical Computing', track: 'Maker', focus: 'Arduino projects with virtual integration', prereq: 'Electronics 2: Machines and Robots, Game Dev 1: Mini Games Creation', level: 2},
      {title: 'Arduino 2: Human Computer Interaction', track: 'Maker', focus: 'Smart systems using sensors and AI inputs', prereq: 'Arduino 1: Physical Computing', level: 2},

      // Level 3 (6)
      {title: '3D Design 2: Modelling with SketchUp', track: 'Designer', focus: 'Advanced modeling and spatial design', prereq: '3D Design 1: Build with TinkerCad', level: 3},
      {title: 'Game Dev 2: Designing for XR', track: 'Designer', focus: 'Immerisive experiences for virtual and augmented reality', prereq: 'Game Dev 1: Mini Games Creation, 3D Design 1: Build with TinkerCad', level: 3},
      {title: 'App Dev 1: UI Design & Mobile Games', track: 'Coder', focus: 'Mobile game creation with UI design', prereq: 'AI 2: Problem Solving and Algorithm', level: 3},
      {title: 'App Dev 2: APIs and Database Integration', track: 'Coder', focus: 'Connect apps to real-time data and API services', prereq: 'App Dev 1: UI Design & Mobile Games', level: 3},
      {title: 'Arduino 3: Machine Learning with Sensors', track: 'Maker', focus: 'Collect data and apply ML models with hardware', prereq: 'Arduino 2: Human Computer Interaction', level: 3},
      {title: 'Arduino 4: Programming with C', track: 'Maker', focus: 'C programming for Arduino', prereq: 'Arduino 3: Machine Learning with Sensors', level: 3},

      // Level 4 (6)
      {title: '3D Design 3: Animate with Blender', track: 'Designer', focus: 'Animate 3D scenes and characters', prereq: '3D Design 2: Modelling with SketchUp', level: 4},
      {title: 'Game Dev 3: Level Up with Godot', track: 'Designer', focus: 'Build cross-platform 2D games and applications', prereq: 'Game Dev 2: Designing for XR', level: 4},
      {title: 'AI 3: Data and Regression', track: 'Coder', focus: 'Data science life cycle and regression', prereq: 'App Dev 2: APIs and Database Integration', level: 4},
      {title: 'AI 4: Predictive and Probabilistic Models', track: 'Coder', focus: 'Supervised, Unsupervised and Probabilistic AI', prereq: 'AI 3: Data and Regression', level: 4},
      {title: 'IoT Systems 1: Smart Devices with ESP32', track: 'Maker', focus: 'Wireless and remote smart device control', prereq: 'Arduino 4: Programming with C, App Dev 1: UI Design & Mobile Games', level: 4},
      {title: 'IoT Systems 2: Edge Computing with AI', track: 'Maker', focus: 'Train and deploy ML models on-device', prereq: 'AI 4: Predictive and Probabilistic Models, IoT Systems 1: Smart Devices with ESP32', level: 4}
    ];

    // Quick lookup for course objects by title
    const COURSE_INDEX = Object.fromEntries(COURSES.map(c => [c.title, c]));

    // ===== Render =====
    const container = document.getElementById('pathway');

    const grouped = COURSES.reduce((acc, c) => { (acc[c.level] ||= []).push(c); return acc; }, {});

    Object.keys(grouped).sort((a,b) => a-b).forEach(level => {
      const section = document.createElement('div');
      section.className = 'level-section';
      section.style.setProperty('--level-color', LEVEL_COLORS[level]);

      const label = document.createElement('div');
      label.className = 'level-label';
      label.textContent = LEVEL_NAMES[level] || `Level ${level}`;
      label.setAttribute('role','button');
      label.setAttribute('aria-expanded','false');
      label.tabIndex = 0;
      section.appendChild(label);

      const row = document.createElement('div');
      row.className = 'course-row';

      // Group by track to keep fixed columns (Designer, Coder, Maker)
      const byTrack = { Designer: [], Coder: [], Maker: [] };
      grouped[level].forEach(c => { if (byTrack[c.track]) byTrack[c.track].push(c); });

      ['Designer','Coder','Maker'].forEach(trackName => {
        const col = document.createElement('div');
        col.className = 'track-col';
        (byTrack[trackName] || []).forEach(c => {
          const card = document.createElement('div');
          card.className = 'course-block';
          card.style.setProperty('--level-color', LEVEL_COLORS[level]);

          const bubble = document.createElement('div');
          bubble.className = 'track-bubble';
          bubble.textContent = c.track;
          card.appendChild(bubble);

          const title = document.createElement('div');
          title.textContent = c.title;
          card.appendChild(title);
          card.dataset.title = c.title; // for lookups

          card.addEventListener('click', () => showDetails(c));
          col.appendChild(card);
        });
        row.appendChild(col);
      });

      section.appendChild(row);
      container.appendChild(section);

      function toggle() {
        const isOpen = section.classList.toggle('open');
        label.setAttribute('aria-expanded', String(isOpen));
      }
      label.addEventListener('click', toggle);
      label.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); } });
    });

    // Build a fast index of titles -> elements for chip navigation
    const TITLE_INDEX = {};
    document.querySelectorAll('.course-block').forEach(card => {
      const section = card.closest('.level-section');
      const label = section.querySelector('.level-label');
      const title = card.dataset.title || card.textContent.trim();
      TITLE_INDEX[title] = { card, section, label };
    });

    function openSection(section, label) {
      if (!section.classList.contains('open')) {
        section.classList.add('open');
        if (label) label.setAttribute('aria-expanded', 'true');
      }
    }
    function goToCourseByTitle(title) {
      const entry = TITLE_INDEX[title];
      if (!entry) return null;
      openSection(entry.section, entry.label);
      entry.card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      entry.card.classList.add('highlight');
      setTimeout(() => entry.card.classList.remove('highlight'), 1200);
      try { entry.card.focus(); } catch {}
      return entry;
    }

    // Helper: set active card + dim others
    function setActiveCourse(title){
      // clear any previous active state
      document.querySelectorAll('.course-block.active').forEach(el => el.classList.remove('active'));
      container.classList.add('dim-others');
      const entry = TITLE_INDEX[title];
      if (entry) { entry.card.classList.add('active'); }
    }
    function clearActiveCourse(){
      container.classList.remove('dim-others');
      document.querySelectorAll('.course-block.active').forEach(el => el.classList.remove('active'));
    }

    // Navigate to a course and show its dialog
    function openAndShowCourse(title) {
      const entry = goToCourseByTitle(title);
      const course = COURSE_INDEX[title];
      if (!entry || !course) return;
      // allow scroll animation to start before opening dialog
      setTimeout(() => { showDetails(course); }, 300);
    }

    // ===== Dialog =====
    const dialog = document.getElementById('detailsDialog');
    const dTitle = document.getElementById('dTitle');
    const dMeta  = document.getElementById('dMeta');
    const dDesc  = document.getElementById('dDesc');
    const dNext  = document.getElementById('dNext');
    const dNextTitle = document.getElementById('dNextTitle');
    const closeBtn = document.getElementById('closeBtn');

    function showDetails(course) {
      // set active & dim others
      setActiveCourse(course.title);

      dTitle.textContent = course.title;
      dMeta.textContent  = `Level ${course.level} · ${course.track}`;
      dDesc.innerHTML    = `<strong>Focus:</strong> ${course.focus || 'N/A'}<br><strong>Prerequisite(s):</strong> ${course.prereq || 'None'}`;

      // Build next-course chips in dialog
      dNext.innerHTML = '';
      const nextList = (SUGGESTED_NEXT[course.title] || []).filter(Boolean);
      if (nextList.length) {
        nextList.forEach(n => {
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.className = 'next-chip';
          chip.textContent = n;
          chip.setAttribute('aria-label', `Go to ${n}`);
          chip.addEventListener('click', () => { dialog.close(); openAndShowCourse(n); });
          dNext.appendChild(chip);
        });
        dNext.style.display = 'flex';
      if (dNextTitle) { dNextTitle.style.display = 'block'; dNextTitle.textContent = 'Suggested Next Course(s):'; }
    } else {
      dNext.style.display = 'none';
      if (dNextTitle) { dNextTitle.style.display = 'none'; }
    }

      dialog.showModal();
    }

    // Clear dim/active whenever the dialog closes (button, ESC, or backdrop)
    dialog.addEventListener('close', clearActiveCourse);
    closeBtn.addEventListener('click', () => dialog.close());

    // ===== Smoke Tests (console) =====
    (function runTests(){
      // Hide UI while tests run to prevent any visible flash/glitch
      document.body.classList.add('testing');
      const logEl = document.getElementById('testLog');
      const lines = [];
      function log(msg){ lines.push(String(msg)); }
      function flush(){ const joined = lines.join('\n'); logEl.textContent = joined; console.log(joined); }

      // ensure test side-effects don't alter initial UI state
      function collapseAllLevels(){
        document.querySelectorAll('.level-section').forEach(s => {
          s.classList.remove('open');
          const lbl = s.querySelector('.level-label');
          if (lbl) lbl.setAttribute('aria-expanded','false');
        });
      }

      try {
        // 1) Correct levels rendered
        const sections = Array.from(document.querySelectorAll('.level-section'));
        console.assert(sections.length === 4, 'Should render 4 levels');
        log(`Levels rendered: ${sections.length}`);

        // 2) Collapsed by default
        const anyOpen = sections.some(s => s.classList.contains('open'));
        console.assert(!anyOpen, 'Levels should be collapsed by default');
        log('Collapsed by default: OK');

        // 3) Total course count = 24
        const total = Array.from(document.querySelectorAll('.course-block')).length;
        console.assert(total === 24, `Expected 24 courses, got ${total}`);
        log(`Total courses: ${total}`);

        // 4) Track columns exist per level (3 cols)
        const firstRowCols = sections[0].querySelectorAll('.track-col').length;
        console.assert(firstRowCols === 3, `Expected 3 columns per level, got ${firstRowCols}`);
        log(`Columns per level: ${firstRowCols}`);

        // 5) Open/close toggling works
        const firstLabel = sections[0].querySelector('.level-label');
        firstLabel.click();
        console.assert(sections[0].classList.contains('open'), 'Level should open on click');
        firstLabel.click();
        console.assert(!sections[0].classList.contains('open'), 'Level should close on second click');
        log('Toggle open/close: OK');

        // 6) Dialog shows suggested-next chips and navigation opens section & dialog for target
        firstLabel.click(); // open level 1
        const blocksL1 = sections[0].querySelectorAll('.course-block');
        blocksL1[0].click(); // open dialog for first course
        const expectedNext = (SUGGESTED_NEXT[blocksL1[0].dataset.title || blocksL1[0].textContent.trim()] || []).length;
        const chips = document.querySelectorAll('#dNext .next-chip');
        console.assert(chips.length === expectedNext, `Dialog chips ${chips.length} should equal mapping ${expectedNext}`);
        log(`Dialog next chips: ${chips.length}/${expectedNext}`);
        if (chips.length > 0) {
          const targetTitle = chips[0].textContent;
          chips[0].click(); // should close dialog, open target level, and reopen dialog for target
          setTimeout(() => {
            const entry = TITLE_INDEX[targetTitle];
            console.assert(entry && entry.section.classList.contains('open'), 'Target section should be open after navigation');
            console.assert(dialog.open === true && document.getElementById('dTitle').textContent === targetTitle, 'Dialog should reopen showing target course');
            log('Chip navigation opens section and shows dialog: OK');
          }, 400);
        }
        // close at end
        setTimeout(() => dialog.close(), 600);

        // 7) goToCourseByTitle should open deep-level course and set aria-expanded
        const deepTitle = 'IoT Systems 2: Edge Computing with AI';
        const entry7 = goToCourseByTitle(deepTitle);
        console.assert(entry7 && entry7.section.querySelector('.level-label').getAttribute('aria-expanded') === 'true', 'aria-expanded should be true after navigation');
        log('Deep navigation aria-expanded: OK');

        // 8) TITLE_INDEX should include all 24 courses
        const idxCount = Object.keys(TITLE_INDEX).length;
        console.assert(idxCount === 24, `TITLE_INDEX expected 24, got ${idxCount}`);
        log(`TITLE_INDEX size: ${idxCount}`);

        // 9) When dialog is open, others are dimmed and active card is not
        const someTitle = 'Blocks 1: Play and Code';
        openAndShowCourse(someTitle);
        setTimeout(() => {
          console.assert(container.classList.contains('dim-others'), 'Container should have dim-others class while dialog open');
          const active = document.querySelector('.course-block.active');
          console.assert(active && (active.dataset.title === someTitle), 'Active card should be marked for selected course');
          log('Dimming behavior: OK');
          dialog.close();
        }, 350);
      } catch (e) {
        console.error('Test error:', e);
        log('Test error: ' + (e && e.message ? e.message : e));
      } finally {
        flush();
        setTimeout(() => {
          // ensure UI reset
          document.querySelectorAll('.level-section').forEach(s => {
            s.classList.remove('open');
            const lbl = s.querySelector('.level-label');
            if (lbl) lbl.setAttribute('aria-expanded','false');
          });
          container.classList.remove('dim-others');
          document.querySelectorAll('.course-block.active').forEach(el => el.classList.remove('active'));
        }, 700);
        // Reveal UI just after cleanup so nothing appears to auto-open
        setTimeout(() => document.body.classList.remove('testing'), 750);
      }
    })();
  </script>
<script>
(function(){
  // --- Explicit track map (authoritative) ---
  const TRACK_MAP = {
    "Blocks 1: Play and Code": "Coder",
    "Blocks 2: Mobile Coding": "Coder",
    "Electronics 1: Circuits and STEM": "Maker",
    "Electronics 2: Machines and Robots": "Maker",
    "Storytelling 1: Digital Animation": "Designer",
    "3D Design 1: Build with TinkerCad": "Designer",
    "Storytelling 2: Creative Computing": "Designer",
    "Game Dev 1: Mini Games Creation": "Designer",
    "Arduino 1: Physical Computing": "Maker",
    "Arduino 2: Human Computer Interaction": "Maker",
    "AI 1: Computational Thinking": "Coder",
    "AI 2: Problem Solving and Algorithm": "Coder",
    "3D Design 2: Modelling with SketchUp": "Designer",
    "Game Dev 2: Designing for XR": "Designer",
    "Arduino 3: Machine Learning with Sensors": "Maker",
    "Arduino 4: Programming with C": "Maker",
    "App Dev 1: UI Design and Mobile Games": "Coder",
    "App Dev 1: UI Design & Mobile Games": "Coder",
    "App Dev 2: APIs and Database Integration": "Coder",
    "AI 3: Data and Regression": "Coder",
    "AI 4: Predictive and Probabilistic Models": "Coder",
    "IoT Systems 1: Smart Devices with ESP32": "Maker",
    "IoT Systems 2: Edge Computing with AI": "Maker",
    "3D Design 3: Animate with Blender": "Designer",
    "Game Dev 3: Level Up with Godot": "Designer"
  };

  // --- Startup preset: open Level 1 and preselect its six courses ---
  const STARTUP_SELECTED = [
    "Blocks 1: Play and Code",
    "Blocks 2: Mobile Coding",
    "Electronics 1: Circuits and STEM",
    "Electronics 2: Machines and Robots",
    "Storytelling 1: Digital Animation",
    "3D Design 1: Build with TinkerCad"
  ];
  let DID_STARTUP_PRESET = false;

  // --- Topic inference (fallback) ---
  function inferTopics(title){
    const t = String(title || '').toLowerCase();
    const topics = [];
    if (t.includes('blocks')) topics.push('Blocks');
    if (t.includes('electronic') || t.includes('circuit')) topics.push('Electronics');
    if (t.includes('storytelling') || t.includes('animation')) topics.push('Storytelling');
    if (t.includes('3d design') || t.includes('tinkercad') || t.includes('sketchup') || t.includes('blender')) topics.push('3D Design');
    if (t.includes('game dev') || t.includes('mini game') || t.includes('godot') || t.includes('xr')) topics.push('Game Dev');
    if (t.includes('arduino')) topics.push('Arduino');
    if (t.includes('ai ' ) || t.startsWith('ai') || t.includes(' ai')) topics.push('AI');
    if (t.includes('app dev') || t.includes('ui design') || t.includes('apis') || t.includes('database')) topics.push('App Dev');
    if (t.includes('iot') || t.includes('esp32') || t.includes('edge')) topics.push('IoT Systems');
    return topics.length ? topics : [''];
  }

  // --- Annotate each course card ---
  function annotateCards(){
    document.querySelectorAll('.course-block').forEach(card => {
      let orig = card.getAttribute('data-title-original');
      if (!orig) {
        orig = card.dataset.title ? card.dataset.title : card.textContent.trim();
        card.setAttribute('data-title-original', orig);
      }
      card.setAttribute('data-title-lc', orig.toLowerCase());

      const courseTrack = TRACK_MAP[orig] || card.dataset.track || '';
      const topics = inferTopics(orig);

      if (courseTrack) card.dataset.track = String(courseTrack).toLowerCase();
      if (topics)      card.dataset.topics = topics.join('|');
    });
  }

  // --- Level helpers ---
  function getLevels(){ return Array.from(document.querySelectorAll('.level-section')); }
  function expandLevel(levelEl){
    if (levelEl.classList.contains('open')) return;
    const label = levelEl.querySelector('.level-label');
    if (label && typeof label.click === 'function') { label.click(); }
    else { levelEl.classList.add('open'); }
  }
  function collapseLevel(levelEl){
    if (!levelEl.classList.contains('open')) return;
    const label = levelEl.querySelector('.level-label');
    if (label && typeof label.click === 'function') { label.click(); }
    else { levelEl.classList.remove('open'); }
  }
  function levelHasMatch(levelEl){
    return !!levelEl.querySelector('.course-block.is-filtered-in');
  }

  // --- Controls ---
  const els = {
    search: document.getElementById('filterSearch'),
    tracks: Array.from(document.querySelectorAll('input[name="track"]')),
    topics: Array.from(document.querySelectorAll('input[name="topic"]')),
    clear:  document.getElementById('filterClear')
  };

  function currentFilters(){
    const q = (els.search && els.search.value || '').trim().toLowerCase();
    const tracks = els.tracks.filter(x => x && x.checked).map(x => String(x.value).toLowerCase());
    const topics = els.topics.filter(x => x && x.checked).map(x => String(x.value).toLowerCase());
    return { q, tracks, topics };
  }

  function matchesFilters(card, f){
    const titleLc = card.getAttribute('data-title-lc') || (card.textContent||'').toLowerCase();
    const track   = (card.dataset.track || '').toLowerCase();
    const topics  = (card.dataset.topics || '').split('|').filter(Boolean).map(t => t.toLowerCase());

    let textOk = true;
    if (f.q){
      const fullText = (titleLc + ' ' + (card.textContent||'').toLowerCase());
      textOk = fullText.includes(f.q);
    }
    let trackOk = true;
    if (f.tracks.length){
      trackOk = f.tracks.includes(track);
    }
    let topicOk = true;
    if (f.topics.length){
      topicOk = topics.some(t => f.topics.includes(t));
    }
    return textOk && trackOk && topicOk;
  }

  function applyFilters(){
    annotateCards();
    const f = currentFilters();
    const nothing = !f.q && !f.tracks.length && !f.topics.length;

    const cards = Array.from(document.querySelectorAll('.course-block'));
    cards.forEach(card => {
      const match = matchesFilters(card, f);
      card.classList.toggle('is-filtered-in', match);
      card.classList.toggle('is-filtered-out', !match);
    });

    const levels = getLevels();
    levels.forEach(level => {
      if (nothing)      { /* keep current startup state */ }
      else if (levelHasMatch(level)) { expandLevel(level); }
      else              { collapseLevel(level); }
    });
  }

  function clearFilters(){
    if (els.search) els.search.value = '';
    els.tracks.forEach(cb => cb.checked = false);
    els.topics.forEach(cb => cb.checked = false);
    applyFilters();
  }

  // Bind events
  if (els.search) ['input','keyup','change'].forEach(evt => els.search.addEventListener(evt, applyFilters));
  [...els.tracks, ...els.topics].forEach(cb => cb.addEventListener('change', applyFilters));
  if (els.clear) els.clear.addEventListener('click', clearFilters);

  // --- Startup: open Level 1 and show six L1 courses ---
  function applyStartupPreset(){
    if (DID_STARTUP_PRESET) return;
    annotateCards();

    const selectedSet = new Set(STARTUP_SELECTED);
    document.querySelectorAll('.course-block').forEach(card => {
      const titleOrig = card.getAttribute('data-title-original') || card.textContent.trim();
      const match = selectedSet.has(titleOrig);
      card.classList.toggle('is-filtered-in', match);
      card.classList.toggle('is-filtered-out', !match);
    });

    const levels = getLevels();
    levels.forEach((level, idx) => {
      const label = level.querySelector('.level-label');
      if (idx === 0) { expandLevel(level); }
      else           { collapseLevel(level); }
    });

    
    // Ensure the top header is visible (scroll to top)
    const topTitle = document.querySelector('h1.title, h1');
    if (topTitle && topTitle.scrollIntoView) {
      topTitle.scrollIntoView({behavior:'auto', block:'start'});
    } else {
      window.scrollTo(0,0);
    }

    DID_STARTUP_PRESET = true;
  }

  
  // Wait until the level sections are built before applying the preset
  function whenReadyToApplyPreset(maxWaitMs = 4000){
    const start = performance.now();
    (function tick(){
      const levelsBuilt = document.querySelectorAll('.level-section').length > 0;
      const firstLabel  = document.querySelector('.level-section .level-label');
      const titleIndexReady = !!window.TITLE_INDEX || document.querySelectorAll('.course-block').length > 0;
      const notTesting = !document.body.classList.contains('testing');
      if (levelsBuilt && firstLabel && titleIndexReady && notTesting){
        applyStartupPreset();
      } else if ((performance.now() - start) < maxWaitMs){
        requestAnimationFrame(tick);
      } else {
        // Fallback: try anyway
        applyStartupPreset();
      }
    })();
  }

  window.addEventListener('load', () => {
    whenReadyToApplyPreset();
  });
  
})();
</script>
<script>
  (function(){
    const btn = document.getElementById('filterToggle');
    const pane = document.getElementById('filterPane');
    if (!btn || !pane) return;

    btn.addEventListener('click', () => {
      pane.classList.toggle('open');
      btn.setAttribute('aria-expanded', pane.classList.contains('open'));
      // Keep the header visible when opening the drawer
      const hdr = document.querySelector('h1.title') || document.querySelector('h1');
      if (pane.classList.contains('open') && hdr && hdr.scrollIntoView) {
        hdr.scrollIntoView({behavior:'smooth', block:'start'});
      }
    });
  })();
</script>
</body>
</html>
